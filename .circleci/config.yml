version: 2.1
jobs:
  build:
    working_directory: /workspace
    docker:
      - image: docker:17.05.0-ce-git
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build and Push Docker image
          command: |
            export DOCKERHUB_NAMESPACE=$DOCKERHUB_NAMESPACE
            export DOCKERHUB_USER=$DOCKERHUB_USER
            export DOCKERHUB_PASS=$DOCKERHUB_PASS
            sh scripts/build-docker-hub.sh      
  deploy_dev:
    working_directory: /workspace
    docker:
      - image: google/cloud-sdk:latest
    steps:
      - checkout
      - run:
          name: Setup gcloud & kubectl
          command: |
            echo $GCP_SERVICE_ACCOUNT_DEV | base64 --decode --ignore-garbage > /root/gcloud-service-key.json
            gcloud auth activate-service-account --key-file /root/gcloud-service-key.json            
            gcloud --quiet config set project $GKE_PROJECT_DEV
            gcloud --quiet config set compute/zone $GKE_ZONE_DEV
            gcloud --quiet container clusters get-credentials $GKE_CLUSTER
      - run:
          name: Deploy on Kubernetes
          command: |
            kubectl apply -f /workspace/deployment/gke/

workflows:
  version: 2.1
  build-and-deploy:
    jobs:
      #- hold-dev: 
      #    type: approval # <<< This key-value pair will set your workflow to a status of "On Hold"
      - build:
          context: TPI
          #requires:
          #  - hold-dev
      - deploy_dev:
          context: TPI
          name: deploy_dev-dev
          requires:
            - build
      - hold-prod: # <<< A job that will require manual approval in the CircleCI web application.
          type: approval # <<< This key-value pair will set your workflow to a status of "On Hold"
          requires: # We only run the "hold" job when test2 has succeeded
            - build
      - deploy_dev:
          context: TPI_PROD
          name: deploy_dev-prod
          requires: # We only run the "hold" job when test2 has succeeded
            - hold-prod
